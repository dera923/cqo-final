#!/usr/bin/env bash
set -euo pipefail

# --- setup ---
BASE=BASE_1
mkdir -p reports/{figures,tables,logs} "reports/compare/${BASE}"/{baseline,new}

# --- SSOT preflight ---
python tools/preflight/ssot_guard.py

# --- core run (存在しない場合はスキップ safe) ---
if python -c "import importlib.util,sys; sys.exit(0 if importlib.util.find_spec('src.cli') else 1)" 2>/dev/null; then
  COMPARE_BASE="${BASE}" python -m src.cli run || true
fi

# --- compare/report (safe no-op) ---
python tools/compare/run_compare.py --base "${BASE}"   || true
python tools/compare/build_compare_html.py            || true
python tools/report/build_report.py                   || true

# --- prepare pytest fixtures (baseline -> reports/tables) ---
cp -f "reports/compare/${BASE}/baseline/summary_metrics.csv"   reports/tables/summary_metrics.csv   || true
cp -f "reports/compare/${BASE}/baseline/estimates.csv"         reports/tables/estimates.csv         || true
cp -f "reports/compare/${BASE}/baseline/policy_kpi.csv"        reports/tables/policy_kpi.csv        || true
cp -f "reports/compare/${BASE}/baseline/adoption_decision.csv" reports/tables/adoption_decision.csv || true

# --- wolfram batch (optional) ---
if command -v wolframscript >/dev/null 2>&1; then
  ./tools/wolfram/export_cards.sh || true
else
  echo "[wolfram] not installed; skip"
fi

# --- adoption (CPI) ---
python tools/policy/cpi_select.py || { echo "[adopt] failed"; exit 1; }

python tools/sanity/ensure_estimates_lcb95.py || true
# --- observability tables (summary_metrics) ---
# NOTE: summary_metrics.csv is generated by gate_sanity.py (gate metrics, not SMD metrics)
# python tools/observability/build_summary_metrics.py --base "${BASE}" || true
# --- step markers (3..11) ---
logstep(){ echo "$(date -u +%FT%TZ) step="$1 >> reports/logs/steps.log; }
mkdir -p reports/logs; : > reports/logs/steps.log
logstep 3  # 探索
logstep 4  # PQS
logstep 5  # RHG
logstep 6  # 適応圧縮
logstep 7  # Adaptive DR & TMLE
logstep 8  # Distributed OPE
logstep 9  # Adaptive DR&TMLE (validate)
logstep 10 # Distributed OPE (aggregate)
logstep 11 # Incremental CF
# --- enforce data contracts before tests ---
python tools/sanity/ensure_estimates_lcb95.py || true
python tools/sanity/ensure_dr_tmle_eif.py   || true
python tools/metrics/build_summary_metrics.py || true
python tools/ope/distributed_ope_agg.py      || true
python tools/cf/incremental_cf_append.py     || true
python tools/figures/build_estimates_figs.py
bash   tools/wolfram/run_batch.sh || true
python tools/checks/sympy_checks.py || true
# --- tests ---
pytest -q || { echo "[pytest] failed"; exit 1; }

echo "done."
